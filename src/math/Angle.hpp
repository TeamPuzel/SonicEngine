// Created by Lua (TeamPuzel) on July 27th 2025.
// Copyright (c) 2025 All rights reserved.
//
// This header defines angle arithmetic used by the game.
#pragma once
#include <primitive>

namespace math {
    /// The original game uses 8 bit angles ranged 0...255 rather than 0...359.
    /// Thanks to that decision angle semantics are already provided to us by the CPU itself.
    ///
    /// However, that is super confusing and not really that meaningful for accuracy.
    /// We also cannot use radians since the intent is to avoid fractional math as much as possible.
    ///
    /// This is a similar implementation to the original game but it extends the range to the
    /// more common degree range.
    class [[clang::trivial_abi]] angle final { // NOLINT(readability-identifier-naming)
        u16 raw;

      public:
        [[clang::always_inline]]
        constexpr operator u32() const {
            return raw;
        }
    };

    namespace detail {
        static constexpr fixed SIN_TABLE[360] = {
            fixed(0,   0),
            fixed(0,   4),
            fixed(0,   9),
            fixed(0,  13),
            fixed(0,  18),
            fixed(0,  22),
            fixed(0,  27),
            fixed(0,  31),
            fixed(0,  36),
            fixed(0,  40),
            fixed(0,  44),
            fixed(0,  49),
            fixed(0,  53),
            fixed(0,  58),
            fixed(0,  62),
            fixed(0,  66),
            fixed(0,  71),
            fixed(0,  75),
            fixed(0,  79),
            fixed(0,  83),
            fixed(0,  88),
            fixed(0,  92),
            fixed(0,  96),
            fixed(0, 100),
            fixed(0, 104),
            fixed(0, 108),
            fixed(0, 112),
            fixed(0, 116),
            fixed(0, 120),
            fixed(0, 124),
            fixed(0, 128),
            fixed(0, 132),
            fixed(0, 136),
            fixed(0, 139),
            fixed(0, 143),
            fixed(0, 147),
            fixed(0, 150),
            fixed(0, 154),
            fixed(0, 158),
            fixed(0, 161),
            fixed(0, 165),
            fixed(0, 168),
            fixed(0, 171),
            fixed(0, 175),
            fixed(0, 178),
            fixed(0, 181),
            fixed(0, 184),
            fixed(0, 187),
            fixed(0, 190),
            fixed(0, 193),
            fixed(0, 196),
            fixed(0, 199),
            fixed(0, 202),
            fixed(0, 204),
            fixed(0, 207),
            fixed(0, 210),
            fixed(0, 212),
            fixed(0, 215),
            fixed(0, 217),
            fixed(0, 219),
            fixed(0, 222),
            fixed(0, 224),
            fixed(0, 226),
            fixed(0, 228),
            fixed(0, 230),
            fixed(0, 232),
            fixed(0, 234),
            fixed(0, 236),
            fixed(0, 237),
            fixed(0, 239),
            fixed(0, 241),
            fixed(0, 242),
            fixed(0, 243),
            fixed(0, 245),
            fixed(0, 246),
            fixed(0, 247),
            fixed(0, 248),
            fixed(0, 249),
            fixed(0, 250),
            fixed(0, 251),
            fixed(0, 252),
            fixed(0, 253),
            fixed(0, 254),
            fixed(0, 254),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 255),
            fixed(1, 000),
            fixed(1, 000),
            fixed(1, 000),
            fixed(1, 000),
            fixed(1, 000),
            fixed(1, 000),
            fixed(1, 000),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 254),
            fixed(0, 254),
            fixed(0, 253),
            fixed(0, 252),
            fixed(0, 251),
            fixed(0, 250),
            fixed(0, 249),
            fixed(0, 248),
            fixed(0, 247),
            fixed(0, 246),
            fixed(0, 245),
            fixed(0, 243),
            fixed(0, 242),
            fixed(0, 241),
            fixed(0, 239),
            fixed(0, 237),
            fixed(0, 236),
            fixed(0, 234),
            fixed(0, 232),
            fixed(0, 230),
            fixed(0, 228),
            fixed(0, 226),
            fixed(0, 224),
            fixed(0, 222),
            fixed(0, 219),
            fixed(0, 217),
            fixed(0, 215),
            fixed(0, 212),
            fixed(0, 210),
            fixed(0, 207),
            fixed(0, 204),
            fixed(0, 202),
            fixed(0, 199),
            fixed(0, 196),
            fixed(0, 193),
            fixed(0, 190),
            fixed(0, 187),
            fixed(0, 184),
            fixed(0, 181),
            fixed(0, 178),
            fixed(0, 175),
            fixed(0, 171),
            fixed(0, 168),
            fixed(0, 165),
            fixed(0, 161),
            fixed(0, 158),
            fixed(0, 154),
            fixed(0, 150),
            fixed(0, 147),
            fixed(0, 143),
            fixed(0, 139),
            fixed(0, 136),
            fixed(0, 132),
            fixed(0, 128),
            fixed(0, 124),
            fixed(0, 120),
            fixed(0, 116),
            fixed(0, 112),
            fixed(0, 108),
            fixed(0, 104),
            fixed(0, 100),
            fixed(0,  96),
            fixed(0,  92),
            fixed(0,  88),
            fixed(0,  83),
            fixed(0,  79),
            fixed(0,  75),
            fixed(0,  71),
            fixed(0,  66),
            fixed(0,  62),
            fixed(0,  58),
            fixed(0,  53),
            fixed(0,  49),
            fixed(0,  44),
            fixed(0,  40),
            fixed(0,  36),
            fixed(0,  31),
            fixed(0,  27),
            fixed(0,  22),
            fixed(0,  18),
            fixed(0,  13),
            fixed(0,   9),
            fixed(0,   4),
            fixed(0,   0),
            fixed(-1, 252),
            fixed(-1, 247),
            fixed(-1, 243),
            fixed(-1, 238),
            fixed(-1, 234),
            fixed(-1, 229),
            fixed(-1, 225),
            fixed(-1, 220),
            fixed(-1, 216),
            fixed(-1, 212),
            fixed(-1, 207),
            fixed(-1, 203),
            fixed(-1, 198),
            fixed(-1, 194),
            fixed(-1, 190),
            fixed(-1, 185),
            fixed(-1, 181),
            fixed(-1, 177),
            fixed(-1, 173),
            fixed(-1, 168),
            fixed(-1, 164),
            fixed(-1, 160),
            fixed(-1, 156),
            fixed(-1, 152),
            fixed(-1, 148),
            fixed(-1, 144),
            fixed(-1, 140),
            fixed(-1, 136),
            fixed(-1, 132),
            fixed(-1, 128),
            fixed(-1, 124),
            fixed(-1, 120),
            fixed(-1, 117),
            fixed(-1, 113),
            fixed(-1, 109),
            fixed(-1, 106),
            fixed(-1, 102),
            fixed(-1,  98),
            fixed(-1,  95),
            fixed(-1,  91),
            fixed(-1,  88),
            fixed(-1,  85),
            fixed(-1,  81),
            fixed(-1,  78),
            fixed(-1,  75),
            fixed(-1,  72),
            fixed(-1,  69),
            fixed(-1,  66),
            fixed(-1,  63),
            fixed(-1,  60),
            fixed(-1,  57),
            fixed(-1,  54),
            fixed(-1,  52),
            fixed(-1,  49),
            fixed(-1,  46),
            fixed(-1,  44),
            fixed(-1,  41),
            fixed(-1,  39),
            fixed(-1,  37),
            fixed(-1,  34),
            fixed(-1,  32),
            fixed(-1,  30),
            fixed(-1,  28),
            fixed(-1,  26),
            fixed(-1,  24),
            fixed(-1,  22),
            fixed(-1,  20),
            fixed(-1,  19),
            fixed(-1,  17),
            fixed(-1,  15),
            fixed(-1,  14),
            fixed(-1,  13),
            fixed(-1,  11),
            fixed(-1,  10),
            fixed(-1,   9),
            fixed(-1,   8),
            fixed(-1,   7),
            fixed(-1,   6),
            fixed(-1,   5),
            fixed(-1,   4),
            fixed(-1,   3),
            fixed(-1,   2),
            fixed(-1,   2),
            fixed(-1,   1),
            fixed(-1,   1),
            fixed(-1,   1),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   1),
            fixed(-1,   1),
            fixed(-1,   1),
            fixed(-1,   2),
            fixed(-1,   2),
            fixed(-1,   3),
            fixed(-1,   4),
            fixed(-1,   5),
            fixed(-1,   6),
            fixed(-1,   7),
            fixed(-1,   8),
            fixed(-1,   9),
            fixed(-1,  10),
            fixed(-1,  11),
            fixed(-1,  13),
            fixed(-1,  14),
            fixed(-1,  15),
            fixed(-1,  17),
            fixed(-1,  19),
            fixed(-1,  20),
            fixed(-1,  22),
            fixed(-1,  24),
            fixed(-1,  26),
            fixed(-1,  28),
            fixed(-1,  30),
            fixed(-1,  32),
            fixed(-1,  34),
            fixed(-1,  37),
            fixed(-1,  39),
            fixed(-1,  41),
            fixed(-1,  44),
            fixed(-1,  46),
            fixed(-1,  49),
            fixed(-1,  52),
            fixed(-1,  54),
            fixed(-1,  57),
            fixed(-1,  60),
            fixed(-1,  63),
            fixed(-1,  66),
            fixed(-1,  69),
            fixed(-1,  72),
            fixed(-1,  75),
            fixed(-1,  78),
            fixed(-1,  81),
            fixed(-1,  85),
            fixed(-1,  88),
            fixed(-1,  91),
            fixed(-1,  95),
            fixed(-1,  98),
            fixed(-1, 102),
            fixed(-1, 106),
            fixed(-1, 109),
            fixed(-1, 113),
            fixed(-1, 117),
            fixed(-1, 120),
            fixed(-1, 124),
            fixed(-1, 128),
            fixed(-1, 132),
            fixed(-1, 136),
            fixed(-1, 140),
            fixed(-1, 144),
            fixed(-1, 148),
            fixed(-1, 152),
            fixed(-1, 156),
            fixed(-1, 160),
            fixed(-1, 164),
            fixed(-1, 168),
            fixed(-1, 173),
            fixed(-1, 177),
            fixed(-1, 181),
            fixed(-1, 185),
            fixed(-1, 190),
            fixed(-1, 194),
            fixed(-1, 198),
            fixed(-1, 203),
            fixed(-1, 207),
            fixed(-1, 212),
            fixed(-1, 216),
            fixed(-1, 220),
            fixed(-1, 225),
            fixed(-1, 229),
            fixed(-1, 234),
            fixed(-1, 238),
            fixed(-1, 243),
            fixed(-1, 247),
            fixed(-1, 252),
        };

        static constexpr fixed COS_TABLE[360] = {
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 254),
            fixed(0, 254),
            fixed(0, 253),
            fixed(0, 252),
            fixed(0, 251),
            fixed(0, 250),
            fixed(0, 249),
            fixed(0, 248),
            fixed(0, 247),
            fixed(0, 246),
            fixed(0, 245),
            fixed(0, 243),
            fixed(0, 242),
            fixed(0, 241),
            fixed(0, 239),
            fixed(0, 237),
            fixed(0, 236),
            fixed(0, 234),
            fixed(0, 232),
            fixed(0, 230),
            fixed(0, 228),
            fixed(0, 226),
            fixed(0, 224),
            fixed(0, 222),
            fixed(0, 219),
            fixed(0, 217),
            fixed(0, 215),
            fixed(0, 212),
            fixed(0, 210),
            fixed(0, 207),
            fixed(0, 204),
            fixed(0, 202),
            fixed(0, 199),
            fixed(0, 196),
            fixed(0, 193),
            fixed(0, 190),
            fixed(0, 187),
            fixed(0, 184),
            fixed(0, 181),
            fixed(0, 178),
            fixed(0, 175),
            fixed(0, 171),
            fixed(0, 168),
            fixed(0, 165),
            fixed(0, 161),
            fixed(0, 158),
            fixed(0, 154),
            fixed(0, 150),
            fixed(0, 147),
            fixed(0, 143),
            fixed(0, 139),
            fixed(0, 136),
            fixed(0, 132),
            fixed(0, 128),
            fixed(0, 124),
            fixed(0, 120),
            fixed(0, 116),
            fixed(0, 112),
            fixed(0, 108),
            fixed(0, 104),
            fixed(0, 100),
            fixed(0,  96),
            fixed(0,  92),
            fixed(0,  88),
            fixed(0,  83),
            fixed(0,  79),
            fixed(0,  75),
            fixed(0,  71),
            fixed(0,  66),
            fixed(0,  62),
            fixed(0,  58),
            fixed(0,  53),
            fixed(0,  49),
            fixed(0,  44),
            fixed(0,  40),
            fixed(0,  36),
            fixed(0,  31),
            fixed(0,  27),
            fixed(0,  22),
            fixed(0,  18),
            fixed(0,  13),
            fixed(0,   9),
            fixed(0,   4),
            fixed(0,   0),
            fixed(-1, 252),
            fixed(-1, 247),
            fixed(-1, 243),
            fixed(-1, 238),
            fixed(-1, 234),
            fixed(-1, 229),
            fixed(-1, 225),
            fixed(-1, 220),
            fixed(-1, 216),
            fixed(-1, 212),
            fixed(-1, 207),
            fixed(-1, 203),
            fixed(-1, 198),
            fixed(-1, 194),
            fixed(-1, 190),
            fixed(-1, 185),
            fixed(-1, 181),
            fixed(-1, 177),
            fixed(-1, 173),
            fixed(-1, 168),
            fixed(-1, 164),
            fixed(-1, 160),
            fixed(-1, 156),
            fixed(-1, 152),
            fixed(-1, 148),
            fixed(-1, 144),
            fixed(-1, 140),
            fixed(-1, 136),
            fixed(-1, 132),
            fixed(-1, 128),
            fixed(-1, 124),
            fixed(-1, 120),
            fixed(-1, 117),
            fixed(-1, 113),
            fixed(-1, 109),
            fixed(-1, 106),
            fixed(-1, 102),
            fixed(-1,  98),
            fixed(-1,  95),
            fixed(-1,  91),
            fixed(-1,  88),
            fixed(-1,  85),
            fixed(-1,  81),
            fixed(-1,  78),
            fixed(-1,  75),
            fixed(-1,  72),
            fixed(-1,  69),
            fixed(-1,  66),
            fixed(-1,  63),
            fixed(-1,  60),
            fixed(-1,  57),
            fixed(-1,  54),
            fixed(-1,  52),
            fixed(-1,  49),
            fixed(-1,  46),
            fixed(-1,  44),
            fixed(-1,  41),
            fixed(-1,  39),
            fixed(-1,  37),
            fixed(-1,  34),
            fixed(-1,  32),
            fixed(-1,  30),
            fixed(-1,  28),
            fixed(-1,  26),
            fixed(-1,  24),
            fixed(-1,  22),
            fixed(-1,  20),
            fixed(-1,  19),
            fixed(-1,  17),
            fixed(-1,  15),
            fixed(-1,  14),
            fixed(-1,  13),
            fixed(-1,  11),
            fixed(-1,  10),
            fixed(-1,   9),
            fixed(-1,   8),
            fixed(-1,   7),
            fixed(-1,   6),
            fixed(-1,   5),
            fixed(-1,   4),
            fixed(-1,   3),
            fixed(-1,   2),
            fixed(-1,   2),
            fixed(-1,   1),
            fixed(-1,   1),
            fixed(-1,   1),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   0),
            fixed(-1,   1),
            fixed(-1,   1),
            fixed(-1,   1),
            fixed(-1,   2),
            fixed(-1,   2),
            fixed(-1,   3),
            fixed(-1,   4),
            fixed(-1,   5),
            fixed(-1,   6),
            fixed(-1,   7),
            fixed(-1,   8),
            fixed(-1,   9),
            fixed(-1,  10),
            fixed(-1,  11),
            fixed(-1,  13),
            fixed(-1,  14),
            fixed(-1,  15),
            fixed(-1,  17),
            fixed(-1,  19),
            fixed(-1,  20),
            fixed(-1,  22),
            fixed(-1,  24),
            fixed(-1,  26),
            fixed(-1,  28),
            fixed(-1,  30),
            fixed(-1,  32),
            fixed(-1,  34),
            fixed(-1,  37),
            fixed(-1,  39),
            fixed(-1,  41),
            fixed(-1,  44),
            fixed(-1,  46),
            fixed(-1,  49),
            fixed(-1,  52),
            fixed(-1,  54),
            fixed(-1,  57),
            fixed(-1,  60),
            fixed(-1,  63),
            fixed(-1,  66),
            fixed(-1,  69),
            fixed(-1,  72),
            fixed(-1,  75),
            fixed(-1,  78),
            fixed(-1,  81),
            fixed(-1,  85),
            fixed(-1,  88),
            fixed(-1,  91),
            fixed(-1,  95),
            fixed(-1,  98),
            fixed(-1, 102),
            fixed(-1, 106),
            fixed(-1, 109),
            fixed(-1, 113),
            fixed(-1, 117),
            fixed(-1, 120),
            fixed(-1, 124),
            fixed(-1, 128),
            fixed(-1, 132),
            fixed(-1, 136),
            fixed(-1, 140),
            fixed(-1, 144),
            fixed(-1, 148),
            fixed(-1, 152),
            fixed(-1, 156),
            fixed(-1, 160),
            fixed(-1, 164),
            fixed(-1, 168),
            fixed(-1, 173),
            fixed(-1, 177),
            fixed(-1, 181),
            fixed(-1, 185),
            fixed(-1, 190),
            fixed(-1, 194),
            fixed(-1, 198),
            fixed(-1, 203),
            fixed(-1, 207),
            fixed(-1, 212),
            fixed(-1, 216),
            fixed(-1, 220),
            fixed(-1, 225),
            fixed(-1, 229),
            fixed(-1, 234),
            fixed(-1, 238),
            fixed(-1, 243),
            fixed(-1, 247),
            fixed(-1, 252),
            fixed(0,   0),
            fixed(0,   4),
            fixed(0,   9),
            fixed(0,  13),
            fixed(0,  18),
            fixed(0,  22),
            fixed(0,  27),
            fixed(0,  31),
            fixed(0,  36),
            fixed(0,  40),
            fixed(0,  44),
            fixed(0,  49),
            fixed(0,  53),
            fixed(0,  58),
            fixed(0,  62),
            fixed(0,  66),
            fixed(0,  71),
            fixed(0,  75),
            fixed(0,  79),
            fixed(0,  83),
            fixed(0,  88),
            fixed(0,  92),
            fixed(0,  96),
            fixed(0, 100),
            fixed(0, 104),
            fixed(0, 108),
            fixed(0, 112),
            fixed(0, 116),
            fixed(0, 120),
            fixed(0, 124),
            fixed(0, 128),
            fixed(0, 132),
            fixed(0, 136),
            fixed(0, 139),
            fixed(0, 143),
            fixed(0, 147),
            fixed(0, 150),
            fixed(0, 154),
            fixed(0, 158),
            fixed(0, 161),
            fixed(0, 165),
            fixed(0, 168),
            fixed(0, 171),
            fixed(0, 175),
            fixed(0, 178),
            fixed(0, 181),
            fixed(0, 184),
            fixed(0, 187),
            fixed(0, 190),
            fixed(0, 193),
            fixed(0, 196),
            fixed(0, 199),
            fixed(0, 202),
            fixed(0, 204),
            fixed(0, 207),
            fixed(0, 210),
            fixed(0, 212),
            fixed(0, 215),
            fixed(0, 217),
            fixed(0, 219),
            fixed(0, 222),
            fixed(0, 224),
            fixed(0, 226),
            fixed(0, 228),
            fixed(0, 230),
            fixed(0, 232),
            fixed(0, 234),
            fixed(0, 236),
            fixed(0, 237),
            fixed(0, 239),
            fixed(0, 241),
            fixed(0, 242),
            fixed(0, 243),
            fixed(0, 245),
            fixed(0, 246),
            fixed(0, 247),
            fixed(0, 248),
            fixed(0, 249),
            fixed(0, 250),
            fixed(0, 251),
            fixed(0, 252),
            fixed(0, 253),
            fixed(0, 254),
            fixed(0, 254),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 255),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
        };
    }

    constexpr auto sin(angle a) -> fixed {
        return detail::SIN_TABLE[a];
    }

    constexpr auto cos(angle a) -> fixed {
        return detail::COS_TABLE[a];
    }
}
