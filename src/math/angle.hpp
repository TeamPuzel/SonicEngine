// Created by Lua (TeamPuzel) on July 27th 2025.
// Copyright (c) 2025 All rights reserved.
//
// This header defines angle arithmetic used by the game.
#pragma once
#include <primitive>

namespace math {
    /// The original game uses 8 bit angles ranged 0...255 rather than 0...359.
    /// Thanks to that decision angle semantics were already provided to us by the CPU itself.
    ///
    /// However, that is super confusing and not really that meaningful for accuracy.
    /// Good news however, the implementation is just a wrapping constructor, and the type otherwise
    /// behaves like a normal unsigned integer.
    ///
    /// This is a similar implementation to the original game but it extends the range to the
    /// more common degree range.
    class [[clang::trivial_abi]] angle final { // NOLINT(readability-identifier-naming)
        u16 raw { 0 };

      public:
        constexpr angle() noexcept {};

        /// Construction of angles is explicit as otherwise math would be pretty easy to mess up otherwise.
        constexpr angle(u16 raw) noexcept : raw(raw % 360) {}

        [[clang::always_inline]] constexpr explicit operator u64() const noexcept {
            return raw;
        }

        [[clang::always_inline]] constexpr explicit operator u32() const noexcept {
            return raw;
        }

        [[clang::always_inline]] constexpr explicit operator u16() const noexcept {
            return raw;
        }

        constexpr auto operator+(angle other) const noexcept -> angle {
            return angle(raw + other.raw);
        }

        constexpr auto operator-(angle other) const noexcept -> angle {
            return angle(raw - other.raw);
        }

        constexpr void operator+=(angle other) noexcept {
            *this = angle(raw + other.raw);
        }

        constexpr void operator-=(angle other) noexcept {
            *this = angle(raw - other.raw);
        }
    };
}

[[clang::always_inline]]
constexpr auto operator==(math::angle lhs, math::angle rhs) noexcept -> bool {
    return u16(lhs) == u16(rhs);
}

[[clang::always_inline]]
constexpr auto operator!=(math::angle lhs, math::angle rhs) noexcept -> bool {
    return u16(lhs) != u16(rhs);
}

[[clang::always_inline]]
constexpr auto operator<(math::angle lhs, math::angle rhs) noexcept -> bool {
    return u16(lhs) < u16(rhs);
}

[[clang::always_inline]]
constexpr auto operator<=(math::angle lhs, math::angle rhs) noexcept -> bool {
    return u16(lhs) <= u16(rhs);
}

[[clang::always_inline]]
constexpr auto operator>(math::angle lhs, math::angle rhs) noexcept -> bool {
    return u16(lhs) > u16(rhs);
}

[[clang::always_inline]]
constexpr auto operator>=(math::angle lhs, math::angle rhs) noexcept -> bool {
    return u16(lhs) >= u16(rhs);
}

namespace math {
    namespace detail {
        static constexpr fixed SIN_TABLE[360] = {
            fixed(0,   0),
            fixed(0,   4),
            fixed(0,   9),
            fixed(0,  13),
            fixed(0,  18),
            fixed(0,  22),
            fixed(0,  27),
            fixed(0,  31),
            fixed(0,  36),
            fixed(0,  40),
            fixed(0,  44),
            fixed(0,  49),
            fixed(0,  53),
            fixed(0,  58),
            fixed(0,  62),
            fixed(0,  66),
            fixed(0,  71),
            fixed(0,  75),
            fixed(0,  79),
            fixed(0,  83),
            fixed(0,  88),
            fixed(0,  92),
            fixed(0,  96),
            fixed(0, 100),
            fixed(0, 104),
            fixed(0, 108),
            fixed(0, 112),
            fixed(0, 116),
            fixed(0, 120),
            fixed(0, 124),
            fixed(0, 128),
            fixed(0, 132),
            fixed(0, 136),
            fixed(0, 139),
            fixed(0, 143),
            fixed(0, 147),
            fixed(0, 150),
            fixed(0, 154),
            fixed(0, 158),
            fixed(0, 161),
            fixed(0, 165),
            fixed(0, 168),
            fixed(0, 171),
            fixed(0, 175),
            fixed(0, 178),
            fixed(0, 181),
            fixed(0, 184),
            fixed(0, 187),
            fixed(0, 190),
            fixed(0, 193),
            fixed(0, 196),
            fixed(0, 199),
            fixed(0, 202),
            fixed(0, 204),
            fixed(0, 207),
            fixed(0, 210),
            fixed(0, 212),
            fixed(0, 215),
            fixed(0, 217),
            fixed(0, 219),
            fixed(0, 222),
            fixed(0, 224),
            fixed(0, 226),
            fixed(0, 228),
            fixed(0, 230),
            fixed(0, 232),
            fixed(0, 234),
            fixed(0, 236),
            fixed(0, 237),
            fixed(0, 239),
            fixed(0, 241),
            fixed(0, 242),
            fixed(0, 243),
            fixed(0, 245),
            fixed(0, 246),
            fixed(0, 247),
            fixed(0, 248),
            fixed(0, 249),
            fixed(0, 250),
            fixed(0, 251),
            fixed(0, 252),
            fixed(0, 253),
            fixed(0, 254),
            fixed(0, 254),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 255),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 254),
            fixed(0, 254),
            fixed(0, 253),
            fixed(0, 252),
            fixed(0, 251),
            fixed(0, 250),
            fixed(0, 249),
            fixed(0, 248),
            fixed(0, 247),
            fixed(0, 246),
            fixed(0, 245),
            fixed(0, 243),
            fixed(0, 242),
            fixed(0, 241),
            fixed(0, 239),
            fixed(0, 237),
            fixed(0, 236),
            fixed(0, 234),
            fixed(0, 232),
            fixed(0, 230),
            fixed(0, 228),
            fixed(0, 226),
            fixed(0, 224),
            fixed(0, 222),
            fixed(0, 219),
            fixed(0, 217),
            fixed(0, 215),
            fixed(0, 212),
            fixed(0, 210),
            fixed(0, 207),
            fixed(0, 204),
            fixed(0, 202),
            fixed(0, 199),
            fixed(0, 196),
            fixed(0, 193),
            fixed(0, 190),
            fixed(0, 187),
            fixed(0, 184),
            fixed(0, 181),
            fixed(0, 178),
            fixed(0, 175),
            fixed(0, 171),
            fixed(0, 168),
            fixed(0, 165),
            fixed(0, 161),
            fixed(0, 158),
            fixed(0, 154),
            fixed(0, 150),
            fixed(0, 147),
            fixed(0, 143),
            fixed(0, 139),
            fixed(0, 136),
            fixed(0, 132),
            fixed(0, 128),
            fixed(0, 124),
            fixed(0, 120),
            fixed(0, 116),
            fixed(0, 112),
            fixed(0, 108),
            fixed(0, 104),
            fixed(0, 100),
            fixed(0,  96),
            fixed(0,  92),
            fixed(0,  88),
            fixed(0,  83),
            fixed(0,  79),
            fixed(0,  75),
            fixed(0,  71),
            fixed(0,  66),
            fixed(0,  62),
            fixed(0,  58),
            fixed(0,  53),
            fixed(0,  49),
            fixed(0,  44),
            fixed(0,  40),
            fixed(0,  36),
            fixed(0,  31),
            fixed(0,  27),
            fixed(0,  22),
            fixed(0,  18),
            fixed(0,  13),
            fixed(0,   9),
            fixed(0,   4),
            fixed(0,   0),
            -fixed(0,   4),
            -fixed(0,   9),
            -fixed(0,  13),
            -fixed(0,  18),
            -fixed(0,  22),
            -fixed(0,  27),
            -fixed(0,  31),
            -fixed(0,  36),
            -fixed(0,  40),
            -fixed(0,  44),
            -fixed(0,  49),
            -fixed(0,  53),
            -fixed(0,  58),
            -fixed(0,  62),
            -fixed(0,  66),
            -fixed(0,  71),
            -fixed(0,  75),
            -fixed(0,  79),
            -fixed(0,  83),
            -fixed(0,  88),
            -fixed(0,  92),
            -fixed(0,  96),
            -fixed(0, 100),
            -fixed(0, 104),
            -fixed(0, 108),
            -fixed(0, 112),
            -fixed(0, 116),
            -fixed(0, 120),
            -fixed(0, 124),
            -fixed(0, 128),
            -fixed(0, 132),
            -fixed(0, 136),
            -fixed(0, 139),
            -fixed(0, 143),
            -fixed(0, 147),
            -fixed(0, 150),
            -fixed(0, 154),
            -fixed(0, 158),
            -fixed(0, 161),
            -fixed(0, 165),
            -fixed(0, 168),
            -fixed(0, 171),
            -fixed(0, 175),
            -fixed(0, 178),
            -fixed(0, 181),
            -fixed(0, 184),
            -fixed(0, 187),
            -fixed(0, 190),
            -fixed(0, 193),
            -fixed(0, 196),
            -fixed(0, 199),
            -fixed(0, 202),
            -fixed(0, 204),
            -fixed(0, 207),
            -fixed(0, 210),
            -fixed(0, 212),
            -fixed(0, 215),
            -fixed(0, 217),
            -fixed(0, 219),
            -fixed(0, 222),
            -fixed(0, 224),
            -fixed(0, 226),
            -fixed(0, 228),
            -fixed(0, 230),
            -fixed(0, 232),
            -fixed(0, 234),
            -fixed(0, 236),
            -fixed(0, 237),
            -fixed(0, 239),
            -fixed(0, 241),
            -fixed(0, 242),
            -fixed(0, 243),
            -fixed(0, 245),
            -fixed(0, 246),
            -fixed(0, 247),
            -fixed(0, 248),
            -fixed(0, 249),
            -fixed(0, 250),
            -fixed(0, 251),
            -fixed(0, 252),
            -fixed(0, 253),
            -fixed(0, 254),
            -fixed(0, 254),
            -fixed(0, 255),
            -fixed(0, 255),
            -fixed(0, 255),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(0, 255),
            -fixed(0, 255),
            -fixed(0, 255),
            -fixed(0, 254),
            -fixed(0, 254),
            -fixed(0, 253),
            -fixed(0, 252),
            -fixed(0, 251),
            -fixed(0, 250),
            -fixed(0, 249),
            -fixed(0, 248),
            -fixed(0, 247),
            -fixed(0, 246),
            -fixed(0, 245),
            -fixed(0, 243),
            -fixed(0, 242),
            -fixed(0, 241),
            -fixed(0, 239),
            -fixed(0, 237),
            -fixed(0, 236),
            -fixed(0, 234),
            -fixed(0, 232),
            -fixed(0, 230),
            -fixed(0, 228),
            -fixed(0, 226),
            -fixed(0, 224),
            -fixed(0, 222),
            -fixed(0, 219),
            -fixed(0, 217),
            -fixed(0, 215),
            -fixed(0, 212),
            -fixed(0, 210),
            -fixed(0, 207),
            -fixed(0, 204),
            -fixed(0, 202),
            -fixed(0, 199),
            -fixed(0, 196),
            -fixed(0, 193),
            -fixed(0, 190),
            -fixed(0, 187),
            -fixed(0, 184),
            -fixed(0, 181),
            -fixed(0, 178),
            -fixed(0, 175),
            -fixed(0, 171),
            -fixed(0, 168),
            -fixed(0, 165),
            -fixed(0, 161),
            -fixed(0, 158),
            -fixed(0, 154),
            -fixed(0, 150),
            -fixed(0, 147),
            -fixed(0, 143),
            -fixed(0, 139),
            -fixed(0, 136),
            -fixed(0, 132),
            -fixed(0, 128),
            -fixed(0, 124),
            -fixed(0, 120),
            -fixed(0, 116),
            -fixed(0, 112),
            -fixed(0, 108),
            -fixed(0, 104),
            -fixed(0, 100),
            -fixed(0,  96),
            -fixed(0,  92),
            -fixed(0,  88),
            -fixed(0,  83),
            -fixed(0,  79),
            -fixed(0,  75),
            -fixed(0,  71),
            -fixed(0,  66),
            -fixed(0,  62),
            -fixed(0,  58),
            -fixed(0,  53),
            -fixed(0,  49),
            -fixed(0,  44),
            -fixed(0,  40),
            -fixed(0,  36),
            -fixed(0,  31),
            -fixed(0,  27),
            -fixed(0,  22),
            -fixed(0,  18),
            -fixed(0,  13),
            -fixed(0,   9),
            -fixed(0,   4),
        };

        static constexpr fixed COS_TABLE[360] = {
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 254),
            fixed(0, 254),
            fixed(0, 253),
            fixed(0, 252),
            fixed(0, 251),
            fixed(0, 250),
            fixed(0, 249),
            fixed(0, 248),
            fixed(0, 247),
            fixed(0, 246),
            fixed(0, 245),
            fixed(0, 243),
            fixed(0, 242),
            fixed(0, 241),
            fixed(0, 239),
            fixed(0, 237),
            fixed(0, 236),
            fixed(0, 234),
            fixed(0, 232),
            fixed(0, 230),
            fixed(0, 228),
            fixed(0, 226),
            fixed(0, 224),
            fixed(0, 222),
            fixed(0, 219),
            fixed(0, 217),
            fixed(0, 215),
            fixed(0, 212),
            fixed(0, 210),
            fixed(0, 207),
            fixed(0, 204),
            fixed(0, 202),
            fixed(0, 199),
            fixed(0, 196),
            fixed(0, 193),
            fixed(0, 190),
            fixed(0, 187),
            fixed(0, 184),
            fixed(0, 181),
            fixed(0, 178),
            fixed(0, 175),
            fixed(0, 171),
            fixed(0, 168),
            fixed(0, 165),
            fixed(0, 161),
            fixed(0, 158),
            fixed(0, 154),
            fixed(0, 150),
            fixed(0, 147),
            fixed(0, 143),
            fixed(0, 139),
            fixed(0, 136),
            fixed(0, 132),
            fixed(0, 128),
            fixed(0, 124),
            fixed(0, 120),
            fixed(0, 116),
            fixed(0, 112),
            fixed(0, 108),
            fixed(0, 104),
            fixed(0, 100),
            fixed(0,  96),
            fixed(0,  92),
            fixed(0,  88),
            fixed(0,  83),
            fixed(0,  79),
            fixed(0,  75),
            fixed(0,  71),
            fixed(0,  66),
            fixed(0,  62),
            fixed(0,  58),
            fixed(0,  53),
            fixed(0,  49),
            fixed(0,  44),
            fixed(0,  40),
            fixed(0,  36),
            fixed(0,  31),
            fixed(0,  27),
            fixed(0,  22),
            fixed(0,  18),
            fixed(0,  13),
            fixed(0,   9),
            fixed(0,   4),
            fixed(0,   0),
            -fixed(0,   4),
            -fixed(0,   9),
            -fixed(0,  13),
            -fixed(0,  18),
            -fixed(0,  22),
            -fixed(0,  27),
            -fixed(0,  31),
            -fixed(0,  36),
            -fixed(0,  40),
            -fixed(0,  44),
            -fixed(0,  49),
            -fixed(0,  53),
            -fixed(0,  58),
            -fixed(0,  62),
            -fixed(0,  66),
            -fixed(0,  71),
            -fixed(0,  75),
            -fixed(0,  79),
            -fixed(0,  83),
            -fixed(0,  88),
            -fixed(0,  92),
            -fixed(0,  96),
            -fixed(0, 100),
            -fixed(0, 104),
            -fixed(0, 108),
            -fixed(0, 112),
            -fixed(0, 116),
            -fixed(0, 120),
            -fixed(0, 124),
            -fixed(0, 128),
            -fixed(0, 132),
            -fixed(0, 136),
            -fixed(0, 139),
            -fixed(0, 143),
            -fixed(0, 147),
            -fixed(0, 150),
            -fixed(0, 154),
            -fixed(0, 158),
            -fixed(0, 161),
            -fixed(0, 165),
            -fixed(0, 168),
            -fixed(0, 171),
            -fixed(0, 175),
            -fixed(0, 178),
            -fixed(0, 181),
            -fixed(0, 184),
            -fixed(0, 187),
            -fixed(0, 190),
            -fixed(0, 193),
            -fixed(0, 196),
            -fixed(0, 199),
            -fixed(0, 202),
            -fixed(0, 204),
            -fixed(0, 207),
            -fixed(0, 210),
            -fixed(0, 212),
            -fixed(0, 215),
            -fixed(0, 217),
            -fixed(0, 219),
            -fixed(0, 222),
            -fixed(0, 224),
            -fixed(0, 226),
            -fixed(0, 228),
            -fixed(0, 230),
            -fixed(0, 232),
            -fixed(0, 234),
            -fixed(0, 236),
            -fixed(0, 237),
            -fixed(0, 239),
            -fixed(0, 241),
            -fixed(0, 242),
            -fixed(0, 243),
            -fixed(0, 245),
            -fixed(0, 246),
            -fixed(0, 247),
            -fixed(0, 248),
            -fixed(0, 249),
            -fixed(0, 250),
            -fixed(0, 251),
            -fixed(0, 252),
            -fixed(0, 253),
            -fixed(0, 254),
            -fixed(0, 254),
            -fixed(0, 255),
            -fixed(0, 255),
            -fixed(0, 255),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(1,   0),
            -fixed(0, 255),
            -fixed(0, 255),
            -fixed(0, 255),
            -fixed(0, 254),
            -fixed(0, 254),
            -fixed(0, 253),
            -fixed(0, 252),
            -fixed(0, 251),
            -fixed(0, 250),
            -fixed(0, 249),
            -fixed(0, 248),
            -fixed(0, 247),
            -fixed(0, 246),
            -fixed(0, 245),
            -fixed(0, 243),
            -fixed(0, 242),
            -fixed(0, 241),
            -fixed(0, 239),
            -fixed(0, 237),
            -fixed(0, 236),
            -fixed(0, 234),
            -fixed(0, 232),
            -fixed(0, 230),
            -fixed(0, 228),
            -fixed(0, 226),
            -fixed(0, 224),
            -fixed(0, 222),
            -fixed(0, 219),
            -fixed(0, 217),
            -fixed(0, 215),
            -fixed(0, 212),
            -fixed(0, 210),
            -fixed(0, 207),
            -fixed(0, 204),
            -fixed(0, 202),
            -fixed(0, 199),
            -fixed(0, 196),
            -fixed(0, 193),
            -fixed(0, 190),
            -fixed(0, 187),
            -fixed(0, 184),
            -fixed(0, 181),
            -fixed(0, 178),
            -fixed(0, 175),
            -fixed(0, 171),
            -fixed(0, 168),
            -fixed(0, 165),
            -fixed(0, 161),
            -fixed(0, 158),
            -fixed(0, 154),
            -fixed(0, 150),
            -fixed(0, 147),
            -fixed(0, 143),
            -fixed(0, 139),
            -fixed(0, 136),
            -fixed(0, 132),
            -fixed(0, 128),
            -fixed(0, 124),
            -fixed(0, 120),
            -fixed(0, 116),
            -fixed(0, 112),
            -fixed(0, 108),
            -fixed(0, 104),
            -fixed(0, 100),
            -fixed(0,  96),
            -fixed(0,  92),
            -fixed(0,  88),
            -fixed(0,  83),
            -fixed(0,  79),
            -fixed(0,  75),
            -fixed(0,  71),
            -fixed(0,  66),
            -fixed(0,  62),
            -fixed(0,  58),
            -fixed(0,  53),
            -fixed(0,  49),
            -fixed(0,  44),
            -fixed(0,  40),
            -fixed(0,  36),
            -fixed(0,  31),
            -fixed(0,  27),
            -fixed(0,  22),
            -fixed(0,  18),
            -fixed(0,  13),
            -fixed(0,   9),
            -fixed(0,   4),
            fixed(0,   0),
            fixed(0,   4),
            fixed(0,   9),
            fixed(0,  13),
            fixed(0,  18),
            fixed(0,  22),
            fixed(0,  27),
            fixed(0,  31),
            fixed(0,  36),
            fixed(0,  40),
            fixed(0,  44),
            fixed(0,  49),
            fixed(0,  53),
            fixed(0,  58),
            fixed(0,  62),
            fixed(0,  66),
            fixed(0,  71),
            fixed(0,  75),
            fixed(0,  79),
            fixed(0,  83),
            fixed(0,  88),
            fixed(0,  92),
            fixed(0,  96),
            fixed(0, 100),
            fixed(0, 104),
            fixed(0, 108),
            fixed(0, 112),
            fixed(0, 116),
            fixed(0, 120),
            fixed(0, 124),
            fixed(0, 128),
            fixed(0, 132),
            fixed(0, 136),
            fixed(0, 139),
            fixed(0, 143),
            fixed(0, 147),
            fixed(0, 150),
            fixed(0, 154),
            fixed(0, 158),
            fixed(0, 161),
            fixed(0, 165),
            fixed(0, 168),
            fixed(0, 171),
            fixed(0, 175),
            fixed(0, 178),
            fixed(0, 181),
            fixed(0, 184),
            fixed(0, 187),
            fixed(0, 190),
            fixed(0, 193),
            fixed(0, 196),
            fixed(0, 199),
            fixed(0, 202),
            fixed(0, 204),
            fixed(0, 207),
            fixed(0, 210),
            fixed(0, 212),
            fixed(0, 215),
            fixed(0, 217),
            fixed(0, 219),
            fixed(0, 222),
            fixed(0, 224),
            fixed(0, 226),
            fixed(0, 228),
            fixed(0, 230),
            fixed(0, 232),
            fixed(0, 234),
            fixed(0, 236),
            fixed(0, 237),
            fixed(0, 239),
            fixed(0, 241),
            fixed(0, 242),
            fixed(0, 243),
            fixed(0, 245),
            fixed(0, 246),
            fixed(0, 247),
            fixed(0, 248),
            fixed(0, 249),
            fixed(0, 250),
            fixed(0, 251),
            fixed(0, 252),
            fixed(0, 253),
            fixed(0, 254),
            fixed(0, 254),
            fixed(0, 255),
            fixed(0, 255),
            fixed(0, 255),
            fixed(1,   0),
            fixed(1,   0),
            fixed(1,   0),
        };
    }

    constexpr auto sin(angle a) noexcept -> fixed {
        return detail::SIN_TABLE[(u32) a];
    }

    constexpr auto cos(angle a) noexcept -> fixed {
        return detail::COS_TABLE[(u32) a];
    }
}
